<!DOCTYPE html>
<!--
    @author Bryan Haberberger
    https://github.com/thehabes
-->
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin="">
        <link rel="stylesheet" href="./marker-clustering/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="./marker-clustering/leaflet.markercluster-src.js"></script>
        <script src="./app.js" type="module"></script>
        <link rel="stylesheet" href="./styling/inset.css" />
    </head>
    <body>
        <div class="row" id="kastorMap">
            <div class="col-12">
                <div class="slider-container is-hidden">
                    <div class="slider-controls">
                        <div class="inline year-dec" title="Move backward one year"> 
                            <span class="inline small-icon"><<</span>
                            <img src="./images/tardis.ico" class="inline small-icon"/> 
                        </div> 
                        <h5 id="slider-value" class="inline">N/A</h5> 
                        <div class="inline year-inc" title="Move forward one year">
                            <span class="icon-fix">hack</span>
                            <img src="./images/tardis.ico" class="inline small-icon"/> 
                            <span class="inline small-icon">>></span>
                        </div>
                    </div>
                    <div class="slide"> 
                        <h5 class="inline">1789</h5>
                        <input id="timeSlider" class="inline" type="range"  min="1789" max="1832" value="1832" step="1">
                        <h5 class="inline">1832</h5>
                    </div>
                </div>
                <div id="leafletInstanceContainer">
                    <div id="loadingMessage" style="text-align: center;">
                        Gathering Federal Employee Data...<br>
                    </div>
                    <div id="resetContainer" class="">
                        <input id="resetView" type="button" class="button primary is-hidden" value="see all locations" />
                    </div>    
                </div>
            </div>
        </div>
        <script>
async function addTaxMetadata(){
    let tax_1798_geo = await fetch("./data/1798_Tax_Divisions_Merged.json").then(resp => resp.json()).catch(err => {return []})
    let metadata_1798 = await fetch("./data/1798_metadata.json").then(resp => resp.json()).catch(err => {return []})
    let tax_1814_geo = await fetch("./data/1814_Districts_Merged.json").then(resp => resp.json()).catch(err => {return []})
    let metadata_1814 = await fetch("./data/1814_metadata.json").then(resp => resp.json()).catch(err => {return []})
    
    let no_1814_metadata = []
    let no_1814_id = []
    let no_1798_metadata = []
    let no_1798_id = []

    let dup_probs_1814 = []
    let dup_probs_1798 = []

    tax_1814_geo.features.forEach(f => {
        let id = f.properties["District1814"]
        if(!id) {
            no_1814_id.push(f)
            return
        }
        let metadata = metadata_1814.filter(m => id === m["District1814"])
        if(metadata.length > 1){
            console.log(`Curious 1814 thing for ${id}`)
            console.log(metadata)
            if(dup_probs_1814.indexOf(id) === -1) dup_probs_1814.push(id)
            return
        }
        if(metadata.length === 0) {
            no_1814_metadata.push(f)
            return
        }
        let combined = Object.assign(f.properties, metadata[0])
        f.properties = combined
    })

    tax_1798_geo.features.forEach(f => {
        let id = f.properties["TaxDivision1798"]
        if(!id) {
            no_1798_id.push(f)
            return
        }
        let metadata = metadata_1798.filter(m => id === m["TaxDivision1798"])
        if(metadata.length > 1){
            console.log(`Curious 1798 thing for ${id}`)
            console.log(metadata)
            if(dup_probs_1798.indexOf(id) === -1) dup_probs_1798.push(id)
            return
        }
        if(metadata.length === 0) {
            no_1798_metadata.push(f)
            return
        }
        let combined = Object.assign(f.properties, metadata[0])
        f.properties = combined
    })

    console.log("duplicates 1798")
    console.log(dup_probs_1798)

    console.log("duplicates 1814")
    console.log(dup_probs_1814)

    console.log(`The following ${no_1814_id.length} 1814 features out of ${tax_1814_geo.features.length} did not have the 'District1814' property`)
    console.log(no_1814_id)

    console.log(`There was no metadata for the following ${no_1814_metadata.length} 1814 features.`)
    console.log(no_1814_metadata)

    console.log(`The following ${no_1798_id.length} 1798 features out of ${tax_1798_geo.features.length} did not have the 'TaxDivision1798' property`)
    console.log(no_1798_id.map(o=>o["TaxDivision1798"]))

    console.log(`There was no metadata for the following ${no_1798_metadata.length} 1798 features.`)
    console.log(no_1798_metadata)

    console.log("1814")
    console.log(tax_1814_geo)

    console.log("1798")
    console.log(tax_1798_geo)

    return true
}
        </script>
    </body>
</html>
